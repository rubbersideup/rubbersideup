<!DOCTYPE html>

<!-- this example based on https://developers.google.com/maps/documentation/javascript/examples/infowindow-simple -->
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Rubber Side Up</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #panel {
        position: absolute;
        text-align: center;
        top: 5px;
        left: 50%;
        margin-left: -360px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        //border: 1px solid #999;
      }
      #title {
        text-align: left;
        font-size: 20pt;
        top: 5px;
        background-color: #fff;
        padding: 5px;
        //border: 1px solid #999;
      }
      #govhack {
        text-align: right;
        size: 8pt;
        top: 5px;
        margin-left: -360px;
        background-color: #fff;
        padding: 5px;
        //border: 1px solid #999;
      }
      </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>

    <!-- this data file contains arrays as produced by the matlab scripts -->
       <script type="text/javascript" src="data.js"></script>

    <script>

var showBySeverity = false;
var markers = [];

// I really should have used arrays for these flags! They just kept growing. Oh well.
var showTruck = true;
var showMotorcycle = true;
var showPedestrian = true;
var showOther = true;
var showAnimal = true;
var showBikeOnly = true;

var showFatal = true;
var showHospital = true;
var showMedical = true;
var showProperty = true;
var showUnknown = true;

var show10kmh = true;
var show30kmh = true;
var show40kmh = true;
var show50kmh = true;
var show60kmh = true;
var show70kmh = true;
var show80kmh = true;
var show90kmh = true;
var show100kmh = true;
var show110kmh = true;
var showunkkmh = true;

var map;

// Adds a marker to the map using the appropriate icon depending on the crash class.
function addMarker(i, map, infowindow)
{
    if (showBySeverity)
    {
      // hacky method for seeing if it starts with that substring
      if (data[i][3].lastIndexOf('Fatal', 0) === 0)
         var icon_url = 'icons/headstone-2.png';
      if (data[i][3].lastIndexOf('Hospital', 0) === 0)
         var icon_url = 'icons/ambulance.png';
      if (data[i][3].lastIndexOf('Medical', 0) === 0)
         var icon_url = 'icons/firstaid.png';
      if (data[i][3].lastIndexOf('Property', 0) === 0)
         var icon_url = 'icons/symbol_dollar.png';
      if (data[i][3].lastIndexOf('Unknown', 0) === 0)
         var icon_url = 'icons/symbol_inter.png';
    }
    else
    {
      // the fields will be either empty or '1'
      if (data[i][4] != '' || data[i][8] != '') // trucks
         var icon_url = 'icons/truck3.png';
      else if (data[i][5] != '') // motorbike
         var icon_url = 'icons/ducati-diavel.png';
      else if (data[i][6] != '') // pedestrian
         var icon_url = 'icons/hiking.png';
      else if (data[i][7] != '') // other
         var icon_url = 'icons/car.png';
      else if (data[i][9] != '') // animal
         var icon_url = 'icons/cow-export.png';
      else // bike only - we stripped out this column
         var icon_url = 'icons/cycling.png';
    }
         
      var marker = new google.maps.Marker({
          position: new google.maps.LatLng(data[i][0], data[i][1]),
          map: map,
          title: data[i][2],
          icon: icon_url
      });
      
      markers.push(marker);
      
    google.maps.event.addListener(marker, 'click', (function(marker, i) {
         return function() {
             infowindow.setContent(data[i][2] + ', ' + data[i][15] +
             '<br>Severity: ' + data[i][3] + 
             '<br>' + data[i][10] + 'km to PSP' + 
             '<br>' + data[i][11] + 'km to PBN' + 
             //'<br>' + data[i][12] + 'km to shared path' +
             '<br>' + data[i][14] + 'km/h zone ' + data[i][13]
             );
             infowindow.open(map, marker);
         }
    })(marker, i));      
      
}

// These are all button event handlers.
function toggleTruck()
{
  showTruck = !showTruck;
  updateVisibility();
}

function toggleMotorcycle()
{
  showMotorcycle = !showMotorcycle;
  updateVisibility();
}

function togglePedestrian()
{
  showPedestrian = !showPedestrian;
  updateVisibility();
}

function toggleOther()
{
  showOther = !showOther;
  updateVisibility();
}

function toggleAnimal()
{
  showAnimal = !showAnimal;
  updateVisibility();
}

function toggleBikeOnly()
{
  showBikeOnly = !showBikeOnly;
  updateVisibility();
}

function toggleFatal()
{
  showFatal = !showFatal;
  updateVisibility();
}

function toggleHospital()
{
  showHospital = !showHospital;
  updateVisibility();
}

function toggleMedical()
{
  showMedical = !showMedical;
  updateVisibility();
}

function toggleProperty()
{
  showProperty = !showProperty;
  updateVisibility();
}

function toggleUnknown()
{
  showUnknown = !showUnknown;
  updateVisibility();
}

function toggle10kmh()
{
  show10kmh = !show10kmh;
  updateVisibility();
}

function toggle30kmh()
{
  show30kmh = !show30kmh;
  updateVisibility();
}
function toggle40kmh()
{
  show40kmh = !show40kmh;
  updateVisibility();
}
function toggle50kmh()
{
  show50kmh = !show50kmh;
  updateVisibility();
}
function toggle60kmh()
{
  show60kmh = !show60kmh;
  updateVisibility();
}
function toggle70kmh()
{
  show70kmh = !show70kmh;
  updateVisibility();
}
function toggle80kmh()
{
  show80kmh = !show80kmh;
  updateVisibility();
}
function toggle90kmh()
{
  show90kmh = !show90kmh;
  updateVisibility();
}
function toggle100kmh()
{
  show100kmh = !show100kmh;
  updateVisibility();
}
function toggle110kmh()
{
  show110kmh = !show110kmh;
  updateVisibility();
}
function toggleunkkmh()
{
  showunkkmh = !showunkkmh;
  updateVisibility();
}


// Changes the icons used to indicate crash severity.
function showSeverityIcons()
{
  showBySeverity = true;
  

  for (i = 0; i < data.length; ++i)
  {
     // hacky method for seeing if it starts with that substring
      if (data[i][3].lastIndexOf('Fatal', 0) === 0)
         var icon_url = 'icons/headstone-2.png';
      if (data[i][3].lastIndexOf('Hospital', 0) === 0)
         var icon_url = 'icons/ambulance.png';
      if (data[i][3].lastIndexOf('Medical', 0) === 0)
         var icon_url = 'icons/firstaid.png';
      if (data[i][3].lastIndexOf('Property', 0) === 0)
         var icon_url = 'icons/symbol_dollar.png';
      if (data[i][3].lastIndexOf('Unknown', 0) === 0)
         var icon_url = 'icons/symbol_inter.png';  
      markers[i].set('icon', icon_url); 

      }
}

// changes the icons used to indicate type of other vehicle involved.
function showVehicleIcons()
{
  showBySeverity = false;

  for (i = 0; i < data.length; ++i)
  {
      // the fields will be either empty or '1'
      if (data[i][4] != '' || data[i][8] != '') // trucks
         var icon_url = 'icons/truck3.png';
      else if (data[i][5] != '') // motorbike
         var icon_url = 'icons/ducati-diavel.png';
      else if (data[i][6] != '') // pedestrian
         var icon_url = 'icons/hiking.png';
      else if (data[i][7] != '') // other
         var icon_url = 'icons/car.png';
      else if (data[i][9] != '') // animal
         var icon_url = 'icons/cow-export.png';
      else // bike only - we stripped out this column
         var icon_url = 'icons/cycling.png';
      markers[i].set('icon', icon_url); 
  }
}

// Compares the crash classes with the currently visible classes.
function updateVisibility()
{
  for (i = 0; i < data.length; ++i)
  {
    var visible = true;
    
    // hacky method for seeing if it starts with that substring
    if (data[i][3].lastIndexOf('Fatal', 0) === 0)
       visible = showFatal;
    if (data[i][3].lastIndexOf('Hospital', 0) === 0)
       visible = showHospital;
    if (data[i][3].lastIndexOf('Medical', 0) === 0)
       visible = showMedical;
    if (data[i][3].lastIndexOf('Property', 0) === 0)
       visible = showProperty;
    if (data[i][3].lastIndexOf('Unknown', 0) === 0)
       visible = showUnknown;
    
    if (!visible)
    {
      markers[i].set('map', null);
      continue;
    }
    
    // hacky method for seeing if it starts with that substring
    if (data[i][4] != '' || data[i][8] != '') // trucks
       visible = showTruck;
    else if (data[i][5] != '') // motorcycle
       visible = showMotorcycle;
    else if (data[i][6] != '') // pedestrian
       visible = showPedestrian;
    else if (data[i][7] != '') // other
       visible = showOther;
    else if (data[i][9] != '') // animal
       visible = showAnimal;
    else // bike only - we stripped out this column
       visible = showBikeOnly;

    if (!visible)
    {
      markers[i].set('map', null);
      continue;
    }
    
    // hacky method for seeing if it starts with that substring
    if (data[i][14] == '10') // 10km/h
       visible = show10kmh;
    else if (data[i][14] == '30')
       visible = show30kmh;
    else if (data[i][14] == '40')
       visible = show40kmh;
    else if (data[i][14] == '50' || data[i][14] == '51') // dataset includes 51 zones...
       visible = show50kmh;
    else if (data[i][14] == '60')
       visible = show60kmh;
    else if (data[i][14] == '70')
       visible = show70kmh;
    else if (data[i][14] == '80')
       visible = show80kmh;
    else if (data[i][14] == '90')
       visible = show90kmh;
    else if (data[i][14] == '100')
       visible = show100kmh;
    else if (data[i][14] == '110')
       visible = show110kmh;
    else 
       visible = showunkkmh;
       
    if (visible)
      markers[i].set('map', map);
    else
      markers[i].set('map', null);
  } // end for
}

// Gets the map up and running
function initialize() {

  var mapOptions = {
    zoom: 10,
    center: new google.maps.LatLng(-31.9546529,115.852662) // Perth
  };

  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

  // If you want to use Google's bike layer, uncomment these lines. 
  // However, their map differs to the DoT in some places (seems to add more routes)
//  var bikeLayer = new google.maps.BicyclingLayer();
//  bikeLayer.setMap(map);

  var pbnLayer = new google.maps.KmlLayer({
    url: 'https://rubbersideup.github.io/rubbersideup/data/converted/PBN_routes_for_arc_dgn_Polyl.kmz'
  });
  pbnLayer.setMap(map);

  var pspLayer = new google.maps.KmlLayer({
    url: 'https://rubbersideup.github.io/rubbersideup/data/converted/Principal_Shared_Path_for_ar.kmz'
  });
  pspLayer.setMap(map);
  
  var contentString = '';

  var infowindow = new google.maps.InfoWindow({
      content: contentString
  });
  
  // add the markers.
  markers = [];
  for (var i = 0; i < data.length; ++i)
  {
    addMarker(i, map, infowindow);
  }
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
  <div id="title"><font size="24">Rubber Side Up</font><br><font size="4"><a href="index.html">Click for project and data info</a></font></div>
  <div id="govhack"><font size="6">GovHack 2015</font></div>
    <div id="panel">
      <button onclick="showVehicleIcons()" >View icons by vehicle:</button>
      <input type="checkbox" checked onclick="toggleTruck()"       id="btnTruck">Trucks</input>
      <input type="checkbox" checked onclick="toggleMotorcycle()"  id="btnMotorcycle">Motorcycles</input>
      <input type="checkbox" checked onclick="togglePedestrian()"  id="btnPedestrian">Pedestrians</input>
      <input type="checkbox" checked onclick="toggleAnimal()"      id="btnAnimal">Animal</input>
      <input type="checkbox" checked onclick="toggleOther()"       id="btnOther">Other</input>
      <input type="checkbox" checked onclick="toggleBikeOnly()"    id="btnBikeOnly">Bike only</input>
      <p>
      <button onclick="showSeverityIcons()" >View icons by severity</button>
      <input type="checkbox" checked onclick="toggleFatal()"       id="btnFatal">Fatal</input>
      <input type="checkbox" checked onclick="toggleHospital()"    id="btnHospital">Hospital</input>
      <input type="checkbox" checked onclick="toggleMedical()"     id="btnMedical">Medical</input>
      <input type="checkbox" checked onclick="toggleProperty()"    id="btnProperty">Property</input>
      <input type="checkbox" checked onclick="toggleUnknown()"     id="btnUnknown">Unknown</input>
      <p>
      Toggle speed limit:
      <input type="checkbox" checked onclick="toggle10kmh()"       >10km/h</input>
      <input type="checkbox" checked onclick="toggle30kmh()"       >30km/h</input>
      <input type="checkbox" checked onclick="toggle40kmh()"       >40km/h</input>
      <input type="checkbox" checked onclick="toggle50kmh()"       >50km/h</input>
      <input type="checkbox" checked onclick="toggle60kmh()"       >60km/h</input>
      <input type="checkbox" checked onclick="toggle70kmh()"       >70km/h</input>
      <input type="checkbox" checked onclick="toggle80kmh()"       >80km/h</input>
      <input type="checkbox" checked onclick="toggle90kmh()"       >90km/h</input>
      <input type="checkbox" checked onclick="toggle100kmh()"      >100km/h</input>
      <input type="checkbox" checked onclick="toggle110kmh()"      >110km/h</input>
      <input type="checkbox" checked onclick="toggleunkkmh()"      >Other</input>
    </div>
    <div id="map-canvas"></div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64823447-1', 'auto');
  ga('send', 'pageview');
    </script>

</body>
</html>